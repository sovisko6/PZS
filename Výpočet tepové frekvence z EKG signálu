import wfdb
import os
import numpy as np
import matplotlib.pyplot as plt

# --- KONFIGURACE CEST ---
CESTA_DRIVEDB = r'C:\Users\jakub\OneDrive\Plocha\PZS1\Data\stress-recognition-in-automobile-drivers-1.0.0'

def zpracuj_signal(signal, fs):
    """
    Robustní funkce, která se přizpůsobí vzorkovací frekvenci (fs).
    """
    # 1. Odstranění trendu (přizpůsobeno fs)
    # Okno 0.2s je univerzální pro odstranění pomalého kolísání
    okno = int(fs * 0.2)
    if okno < 1: okno = 1
    trend = np.convolve(signal, np.ones(okno)/okno, mode='same')
    sig_detrend = signal - trend
    
    # 2. Centrování a automatické otočení
    sig_centered = sig_detrend - np.mean(sig_detrend)
    if np.abs(np.min(sig_centered)) > np.max(sig_centered) * 1.2:
        sig_final = -sig_centered
    else:
        sig_final = sig_centered
        
    # 3. Kvadratura pro zvýraznění špiček
    sig_prep = sig_final**2
    
    # 4. Detekce vrcholů (přizpůsobeno fs)
    praha = 0.15 * np.percentile(sig_prep, 95)
    # Mrtvá doba 0.35s (fyziologické maximum pro tep cca 170 BPM)
    mrtva_doba = int(0.35 * fs)
    
    vrcholy = []
    posledni_v = -mrtva_doba
    
    for i in range(1, len(sig_prep) - 1):
        if sig_prep[i] > praha and sig_prep[i] > sig_prep[i-1] and sig_prep[i] > sig_prep[i+1]:
            if i - posledni_v > mrtva_doba:
                vrcholy.append(i)
                posledni_v = i
                
    return np.array(vrcholy), sig_final

# --- HLAVNÍ CYKLUS ---
vysledky_bpm = []
nazvy_mereni = []

if os.path.exists(CESTA_DRIVEDB):
    soubory = sorted([f.replace('.hea', '') for f in os.listdir(CESTA_DRIVEDB) if f.endswith('.hea')])
    
    for nazev in soubory:
        try:
            rec = wfdb.rdrecord(os.path.join(CESTA_DRIVEDB, nazev))
            idx = rec.sig_name.index('ECG') if 'ECG' in rec.sig_name else 0
            signal = rec.p_signal[:, idx]
            fs = rec.fs # Tady načítáme unikátní frekvenci pro každý soubor
            
            vrcholy, upraveny_sig = zpracuj_signal(signal, fs)
            
            # BPM vypočítané s ohledem na konkrétní fs
            trvani_min = len(signal) / (fs * 60)
            bpm = len(vrcholy) / trvani_min
            
            vysledky_bpm.append(bpm)
            nazvy_mereni.append(nazev)
            
            # INDIVIDUÁLNÍ GRAF (10 sekund pro každého)
            plt.figure(figsize=(12, 4))
            limit = int(fs * 10)
            plt.plot(upraveny_sig[:limit], label=f'EKG (fs={fs}Hz)')
            v_graf = vrcholy[vrcholy < limit]
            plt.plot(v_graf, upraveny_sig[v_graf], 'rx', label='Detekované R')
            plt.title(f"Měření: {nazev} | Tep: {bpm:.2f} BPM")
            plt.legend()
            plt.grid(True, alpha=0.3)
            plt.show()
            
            print(f"Hotovo {nazev} (fs={fs}): {bpm:.2f} BPM")
            
        except Exception as e:
            print(f"Chyba u {nazev}: {e}")

    # SJEDNOCENÝ GRAF
    plt.figure(figsize=(15, 6))
    plt.plot(nazvy_mereni, vysledky_bpm, 'ro-', linewidth=2)
    plt.title('Souhrnný graf tepové frekvence všech řidičů')
    plt.ylabel('BPM')
    plt.xticks(rotation=45)
    plt.grid(True)
    plt.tight_layout()
    plt.show()
